<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin</title>
  <style>
    body{font-family:sans-serif;min-height:100vh;margin:0;background:#0f172a;color:#f1f5f9;}
    .mx-auto{margin-left:auto;margin-right:auto;}
    .max-w-5xl{max-width:64rem;}
    .px-6{padding-left:1.5rem;padding-right:1.5rem;}
    .py-10{padding-top:2.5rem;padding-bottom:2.5rem;}
    .mb-6{margin-bottom:1.5rem;}
    .mt-6,.mt-3,.mt-4,.mt-2{margin-top:1.5rem;}.mt-3{margin-top:0.75rem;}.mt-4{margin-top:1rem;}.mt-2{margin-top:0.5rem;}
    .flex{display:flex;}.flex-col{flex-direction:column;}
    .gap-2,.gap-3,.gap-4{gap:0.5rem;}.gap-3{gap:0.75rem;}.gap-4{gap:1rem;}
    .items-center{align-items:center;}
    .justify-between{justify-content:space-between;}
    .text-xl,.text-3xl{font-size:1.25rem;}.text-3xl{font-size:1.875rem;}
    .text-sm,.text-xs{font-size:0.875rem;}.text-xs{font-size:0.75rem;}
    .font-semibold{font-weight:600;}
    .rounded-xl,.rounded-2xl{border-radius:0.75rem;}.rounded-2xl{border-radius:1rem;}
    .border{border:1px solid #1e293b;}
    .bg-slate-900\/40{background:rgba(15,23,42,0.4);}
    .bg-slate-950{background:#0f172a;}
    .p-6{padding:1.5rem;}
    .px-3,.px-4,.py-1,.py-2,.py-3,.pr-3{padding:0.5rem;}
    .text-slate-300,.text-slate-400,.text-slate-100{color:#94a3b8;}
    .text-slate-100{color:#f1f5f9;}
    .w-full{width:100%;}
    .grid{display:grid;}
    table{width:100%;border-collapse:collapse;}
    th,td{text-align:left;}
    input,select,button{box-sizing:border-box;}
    input,select{background:#0f172a;border:1px solid #1e293b;color:#e2e8f0;padding:0.5rem 1rem;border-radius:0.75rem;width:100%;}
    button{background:#2563eb;color:white;padding:0.5rem 1rem;border-radius:0.75rem;border:none;cursor:pointer;font-weight:600;}
    form input,form select,form button{width:100%;}
    .bg-slate-100{background:#e2e8f0;}
    .text-slate-900{color:#0f172a;}
    .bg-rose-600{background:#e11d48;}
    a{color:#93c5fd;}
    #pageMsg div{margin-top:1rem;padding:0.75rem 1rem;background:rgba(6,78,59,0.4);border-radius:0.75rem;color:#a7f3d0;}
  </style>
</head>
<body class="min-h-screen bg-slate-950 text-slate-100">

<div class="mx-auto max-w-5xl px-6 py-10">

  <!-- Navbar -->
  <div class="mb-6 flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
    <div class="flex items-center gap-3">
      <div class="text-xl font-semibold tracking-tight">Library</div>
      <span class="inline-flex items-center rounded-full border border-slate-800 bg-slate-900/40 px-3 py-1 text-xs text-slate-300">
        <span id="navUsername">...</span> â€¢ <span id="navRole">...</span>
      </span>
    </div>
    <div class="text-sm text-slate-300">
      <a class="hover:text-white underline-offset-4 hover:underline" href="/dashboard">Dashboard</a>
      <span class="mx-2 text-slate-600">|</span>
      <a class="hover:text-white underline-offset-4 hover:underline" href="/logout">Logout</a>
    </div>
  </div>

  <h1 class="text-3xl font-semibold tracking-tight">Admin Dashboard</h1>

  <div id="pageMsg"></div>

  <div class="mt-6 grid grid-cols-1 gap-4 md:grid-cols-2">
    <!-- Create user -->
    <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
      <h2 class="text-lg font-semibold">Create User</h2>
      <form class="mt-3 grid gap-2" method="post" action="/admin/createUser">
        <input class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               name="username" placeholder="username"/>
        <input class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               name="password" placeholder="password"/>
        <select class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
                name="role">
          <option value="STUDENT">STUDENT</option>
          <option value="LIBRARIAN">LIBRARIAN</option>
          <option value="ADMIN">ADMIN</option>
        </select>
        <button class="mt-2 w-full rounded-xl bg-blue-600 px-4 py-2 font-semibold text-white hover:bg-blue-500" type="submit">
          Create
        </button>
      </form>
    </div>

    <!-- Reset/Delete -->
    <div class="rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
      <h2 class="text-lg font-semibold">Reset Password</h2>
      <form class="mt-3 grid gap-2" method="post" action="/admin/resetPassword">
        <input class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               name="username" placeholder="username"/>
        <input class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               name="password" placeholder="new password"/>
        <button class="mt-2 w-full rounded-xl bg-slate-100 px-4 py-2 font-semibold text-slate-900 hover:bg-white" type="submit">
          Reset
        </button>
      </form>

      <h2 class="mt-6 text-lg font-semibold">Delete User</h2>
      <form class="mt-3 flex gap-2" method="post" action="/admin/deleteUser">
        <input class="w-full rounded-xl border border-slate-800 bg-slate-950 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500"
               name="username" placeholder="username"/>
        <button class="w-full rounded-xl bg-rose-600 px-4 py-2 font-semibold text-white hover:bg-rose-500" type="submit">
          Delete
        </button>
      </form>
      <p class="mt-2 text-xs text-slate-400">Demo mode refuses to delete username <b>admin</b>.</p>
    </div>
  </div>

  <!-- Users -->
  <div class="mt-4 rounded-2xl border border-slate-800 bg-slate-900/40 p-6">
    <h2 class="text-lg font-semibold">Users</h2>
    <div class="mt-3 overflow-x-auto">
      <table class="w-full text-sm">
        <thead class="text-left text-xs uppercase tracking-wide text-slate-400">
          <tr class="border-b border-slate-800">
            <th class="py-3 pr-3">Username</th>
            <th class="py-3">Role</th>
          </tr>
        </thead>
        <tbody id="usersBodyAdmin"></tbody>
      </table>
    </div>
  </div>

</div>

<script>
function esc(s){
  return String(s == null ? "" : s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll("\"","&quot;")
    .replaceAll("'","&#39;");
}

async function apiGet(url){
  const res = await fetch(url, { credentials: "same-origin" });
  if(res.status === 401){
    window.location.href = "/login";
    return null;
  }
  return await res.json();
}

function showMsgFromUrl(){
  const msg = new URLSearchParams(window.location.search).get("msg");
  const el = document.getElementById("pageMsg");
  if(!el) return;
  if(!msg){ el.innerHTML = ""; return; }
  el.innerHTML =
    "<div class='mt-4 rounded-xl border border-emerald-900/60 bg-emerald-950/40 px-4 py-3 text-sm text-emerald-100'>"
    + esc(msg) +
    "</div>";
}

function renderUsersRows(tbody, users){
  if(!tbody) return;
  if(!users || users.length === 0){
    tbody.innerHTML = "<tr class='border-b border-slate-900'><td class='py-3 text-slate-400' colspan='2'>No users.</td></tr>";
    return;
  }
  let html = "";
  for(let i=0;i<users.length;i++){
    const u = users[i];
    html += "<tr class='border-b border-slate-900'>"
      + "<td class='py-3 pr-3 font-medium text-slate-100'>" + esc(u.username) + "</td>"
      + "<td class='py-3 text-slate-300'>" + esc(u.role) + "</td>"
      + "</tr>";
  }
  tbody.innerHTML = html;
}

document.addEventListener("DOMContentLoaded", async function(){
  showMsgFromUrl();

  const me = await apiGet("/api/me");
  if(!me) return;
  const uEl = document.getElementById("navUsername");
  const rEl = document.getElementById("navRole");
  if(uEl) uEl.textContent = me.username || "";
  if(rEl) rEl.textContent = me.role || "";

  const body = document.getElementById("usersBodyAdmin");
  const users = await apiGet("/api/admin/users");
  if(!users) return;
  renderUsersRows(body, users);
});
</script>

</body>
</html>

